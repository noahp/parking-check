#!/usr/bin/env bash

set -e

# Check for plate-not-found response
function check_plate() {
    curl -s 'https://vats.municipalcitationsolutions.com/payments/PayVats.aspx?location=47' \
        -H 'Cookie: ASP.NET_SessionId=rm3gxxot3w5hxtfiv3msczhq; Vats_UserDBName=vatsDBMassBayTransAuth' \
        -H 'Origin: https://vats.municipalcitationsolutions.com' -H 'Accept-Encoding: gzip, deflate, br' \
        -H 'Accept-Language: en-US,en;q=0.9' \
        -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.119 Safari/537.36' \
        -H 'Content-Type: application/x-www-form-urlencoded; charset=UTF-8' -H 'Accept: */*' \
        -H 'Cache-Control: no-cache' -H 'X-Requested-With: XMLHttpRequest' -H 'Connection: keep-alive' \
        -H 'X-MicrosoftAjax: Delta=true' -H 'Referer: https://vats.municipalcitationsolutions.com/payments/PayVats.aspx?location=47' \
        --data 'ctl00%24ContentPlaceHolder1%24ScriptManager=ctl00%24ContentPlaceHolder1%24updpan1%7Cctl00%24ContentPlaceHolder1%24btnSearchPlate&ctl00%24ContentPlaceHolder1%24ddlLocations=47&ctl00%24ContentPlaceHolder1%24hfDiscount=0&ctl00%24ContentPlaceHolder1%24hfViolation=&ctl00%24ContentPlaceHolder1%24txtCitationID=&ctl00%24ContentPlaceHolder1%24cbxNoCitationNumber=on&ctl00%24ContentPlaceHolder1%24txtPlateNumber='"$1"'&ctl00%24ContentPlaceHolder1%24ddlVehicleState=MA&__EVENTTARGET=&__EVENTARGUMENT=&__LASTFOCUS=&__VIEWSTATE=%2FwEPDwUJMTEyMTEwMjYzD2QWAmYPZBYCAgMPZBYCZg9kFgICAg9kFgJmD2QWDAIBDw8WAh4EVGV4dAUZUGxhdGUgIzogNzY5TE43IG5vdCBmb3VuZGRkAgUPDxYCHwBlZGQCBw9kFgICAQ9kFgYCAQ9kFgICAQ8QDxYGHg5EYXRhVmFsdWVGaWVsZAUKTG9jYXRpb25JRB4NRGF0YVRleHRGaWVsZAUMTG9jYXRpb25OYW1lHgtfIURhdGFCb3VuZGdkEBUmEVNlbGVjdCBhIExvY2F0aW9uCkJhbmdvciwgTUUOQmFybnN0YWJsZSwgTUEPQmF0b24gUm91Z2UsIExBEENlZGFyIFJhcGlkcywgSUENQ2hhcmxvdHRlLCBOQx1DaGF0dGFub29nYSBQYXJraW5nIEF1dGhvcml0eRxDaGF0dGFub29nYSBSZXB1YmxpYyBQYXJraW5nC0RhbmJ1cnksIENUC0RheXRvbmEsIEZMCkR1cmhhbSwgTkMWRWFnbGUgVmFpbCBBaXJwb3J0LCBDTw5GaXR6c2ltb25zLCBDTwxIYXJ0Zm9yZCwgQ1QWSGlsdG9uIEhlYWQgSXNsYW5kLCBTQxBKYWNrc29udmlsbGUsIEZMDUtub3h2aWxsZSwgVE4ZTGF1ZGVyZGFsZSBCeSBUaGUgU2VhLCBGTAxMYXdyZW5jZSwgTUENTGV4aW5ndG9uLCBLWQtMaW5jb2xuLCBORQ1NYXJxdWV0dGUsIE1JHk1hc3MuIEJheSBUcmFucy4gQXV0aG9yaXR5LCBNQQtNZWRmb3JkLCBNQQxNZW1waGlzLCBUTiAKTW9iaWxlLCBBTAxNb250cm9zZSwgQ08eTmFudHVja2V0IE1lbW9yaWFsIEFpcnBvcnQsIE1BFE5hc2h2aWxsZSwgVE4gKERlbW8pCk5hdGljaywgTUEaT3ZlcnRvbiBTcXVhcmUgTWVtcGhpcywgVE4IUm9tZSwgR0EQUG9pbnQgUnVzdG9uLCBXQRBTdCBKb2huc2J1cnksIFZUDFN0YW1mb3JkLCBDVB5Vbml2LiBvZiBDb2xvcmFkbyBIb3NwaXRhbCwgQ08MV2F0ZXJsb28sIElBDVdpbGxpc3RvbiwgTkQVJhFTZWxlY3QgYSBMb2NhdGlvbgIxMwI1NwI0OQE2AjMxAzUxMQE1AjQxAjEyAjI4AjMwAjEwATICNDQCMzkBOAIyNwI0NQI1MgI0MAExAjQ3AjI1ATMCNTUCNTMCNDgEOTk5OQI0NgEzAjU2AjUwAjE4AjI2AjExAjI5AjQzFCsDJmdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnFgECFmQCAg9kFgICAQ8PFgIfAAUWdmF0c0RCTWFzc0JheVRyYW5zQXV0aGRkAgMPZBYEAgEPDxYCHwAFAk1BZGQCAw8PFgIfAAUCNDdkZAIJDxYCHgdWaXNpYmxlZxYEAgcPDxYCHwBlZGQCCQ8QDxYCHgdDaGVja2VkZ2RkZGQCCw8WAh8EZxYEAgUPZBYCAgMPEA8WBh8CBQtEZXNjcmlwdGlvbh8BBQRDb2RlHwNnZBAVQg5TZWxlY3QgYSBTdGF0ZQ1NYXNzYWNodXNldHRzC0Nvbm5lY3RpY3V0CE5ldyBZb3JrDFJob2RlIElzbGFuZAdWZXJtb250DU5ldyBIYW1wc2hpcmUFTWFpbmUKTmV3IEplcnNleQxQZW5uc3lsdmFuaWEHQWxhYmFtYQZBbGFza2EIQXJrYW5zYXMHQXJpem9uYQpDYWxpZm9ybmlhCENvbG9yYWRvCERlbGF3YXJlB0Zsb3JpZGEHR2VvcmdpYQZIYXdhaWkFSWRhaG8ISWxsaW5vaXMHSW5kaWFuYQRJb3dhBkthbnNhcwhLZW50dWNreQlMb3Vpc2lhbmEITWFyeWxhbmQITWljaGlnYW4JTWlubmVzb3RhC01pc3Npc3NpcHBpCE1pc3NvdXJpB01vbnRhbmEITmVicmFza2EGTmV2YWRhCk5ldyBNZXhpY28OTm9ydGggQ2Fyb2xpbmEMTm9ydGggRGFrb3RhBE9oaW8IT2tsYWhvbWEGT3JlZ29uDlNvdXRoIENhcm9saW5hDFNvdXRoIERha290YQlUZW5uZXNzZWUFVGV4YXMEVXRhaAhWaXJnaW5pYQpXYXNoaW5ndG9uDVdhc2hpbmd0b24gREMNV2VzdCBWaXJnaW5pYQlXaXNjb25zaW4HV3lvbWluZwdBbGJlcnRhEEJyaXRpc2ggQ29sdW1iaWEITWFuaXRvYmENTmV3IEJydW5zd2ljawxOZXdmb3VuZGxhbmQVTm9ydGh3ZXN0IFRlcnJpdG9yaWVzC05vdmEgU2NvdGlhB051bmF2dXQHT250YXJpbxRQcmluY2UgRWR3YXJkIElzbGFuZAZRdWViZWMMU2Fza2F0Y2hld2FuBVl1a29uA1ZJThVCDlNlbGVjdCBhIFN0YXRlAk1BAkNUAk5ZAlJJAlZUAk5IAk1FAk5KAlBBAkFMAkFLAkFSAkFaAkNBAkNPAkRFAkZMAkdBAkhJAklEAklMAklOAklBAktTAktZAkxBAk1EAk1JAk1OAk1TAk1PAk1UAk5FAk5WAk5NAk5DAk5EAk9IAk9LAk9SAlNDAlNEAlROAlRYAlVUAlZBAldBAkRDAldWAldJAldZAkFCAkJDAk1CAk5CAk5MAk5UAk5TAk5VAk9OAlBFAlFDAlNLAllUAlZOFCsDQmdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZxYBAgFkAgkPDxYCHwBlZGQCDw9kFhYCAw88KwARAwAPFgQfA2ceC18hSXRlbUNvdW50ZmQBEBYAFgAWAAwUKwALFggeBE5hbWUFCkNpdGF0aW9uSUQeCklzUmVhZE9ubHloHgRUeXBlGSsCHglEYXRhRmllbGQFCkNpdGF0aW9uSUQWCB8HBQxJc3N1aW5nQWdlbnQfCGgfCRkrAh8KBQxJc3N1aW5nQWdlbnQWCB8HBQxWZWhpY2xlU3RhdGUfCGgfCRkrAh8KBQxWZWhpY2xlU3RhdGUWCB8HBQ5WZWhpY2xlTGljZW5zZR8IaB8JGSsCHwoFDlZlaGljbGVMaWNlbnNlFggfBwULVmVoaWNsZU1ha2UfCGgfCRkrAh8KBQtWZWhpY2xlTWFrZRYIHwcFDFZlaGljbGVDb2xvch8IaB8JGSsCHwoFDFZlaGljbGVDb2xvchYIHwcFDVZpb2xhdGlvbkNvZGUfCGgfCRkrAh8KBQ1WaW9sYXRpb25Db2RlFggfBwUHQmFsYW5jZR8IaB8JGSlbU3lzdGVtLkRlY2ltYWwsIG1zY29ybGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OR8KBQdCYWxhbmNlFggfBwUNSXNzdWVEYXRlVGltZR8IaB8JGSlcU3lzdGVtLkRhdGVUaW1lLCBtc2NvcmxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPWI3N2E1YzU2MTkzNGUwODkfCgUNSXNzdWVEYXRlVGltZRYIHwcFCmRiTG9jYXRpb24fCGgfCRkrAh8KBQpkYkxvY2F0aW9uFggfBwURV2ViUGF5VHJhbnNDaGFyZ2UfCGgfCRkrBB8KBRFXZWJQYXlUcmFuc0NoYXJnZWQCJQ8QZGQWAGQCPQ8WAh8EaGQCSw8QZGQWAGQCUQ8QZGQWAGQCVQ8PFgIeCEltYWdlVXJsBSV%2BL2ltYWdlcy9hY2NlcHRhbmNlbWFya3Nfc3RhbmRhcmQuanBnZGQCYQ8QZGQWAWZkAmkPDxYCHwAFDkFjY2VwdCBQYXltZW50ZGQCaw8PFgIfAAUZUGxhdGUgIzogNzY5TE43IG5vdCBmb3VuZGRkAm8PDxYCHwBlZGQCcw8PFgIfAGVkZBgCBR5fX0NvbnRyb2xzUmVxdWlyZVBvc3RCYWNrS2V5X18WAQUtY3RsMDAkQ29udGVudFBsYWNlSG9sZGVyMSRjYnhOb0NpdGF0aW9uTnVtYmVyBStjdGwwMCRDb250ZW50UGxhY2VIb2xkZXIxJGd2Q2l0YXRpb25EZXRhaWxzDzwrAAwBCGZkogEjoz6%2FnscmfuhWCY1QTUQ0oqF%2FeVyldXPfKln2%2F5s%3D&__VIEWSTATEGENERATOR=8DA55DA2&__SCROLLPOSITIONX=0&__SCROLLPOSITIONY=0&__EVENTVALIDATION=%2FwEdAHAYMclC%2BpPTUv9ZV7dlbfBMkS8YBgboyFmJEbDDPA0oKYzBY0VuTxCVTbwy%2BSqKdGSQAhNfKbTFN7dZNtrpFGkmFjibaNVewCq21no%2FMGPfdb7UYnquk%2B%2FN5X0Ypu7tpwi8dCL7TXvnvCubmFSLm6LtX4iFa5UNI07yK%2FpKUwg4A4DgVdkPtvgjIwAVTB5Fwi%2FpuzDRC4I0XwA6RwVJOYZGPR40XigAkJCEtgGetC3LaOX2MtprdFgoOYkqKZWNRaWjocn6ZcbrLELPQ%2BzT%2F8Vl0s%2F49gdkFfmNciKJ%2Bsh%2F0QQLUx4sxO1zFLlBlme1ccBAL%2FfGZRkRoAYznkd2MQJNG1YyAU%2FvIuvGJbaMlMQfw3V5095bPHGBfMHDywtzgawGG8gkqdRdS4R0pOjp%2BG%2Bwq8JaWIw3sm36NtF0eK0AZ1wO2saVGCIenZxpwUuO1%2Bb8p6Ipy%2Bty7pcfXf9TNYMG53ZZt3oHRrARRnOj5e2Ub4MV35PhAEhKhNFYdh0uClXVsU4Tcec3TgSjjhwg%2BSo%2BJXvdbVMAwi%2BQ7jtH8Mv3DtKo20GlHx3PuSWLx4QocPWSB75LRXtq1%2BSnhK0N1zs6ySTr6gdIuxZvqJWeolDMEzBOvNXRK8RMmO2AkVtr0YcEdiX0sGPsSMTIl501HZBZr6mgWfqKtOL0TJWCgpQPz9krXj8hQYjYrc41e4iramCOK9BDq3Ntj1rACCFrX9EPsVKdnOOAtLKth5B4JSook%2BtIEL%2BNwchdQQSzj5yQClPd%2BTs1Buhok7m0dKBCXES8N4jUxamjNdgao%2BwZHVuVqppAT8ymFmLJESyZqpcKhtwPfbR6CKDT2%2FNs9YHa0S5MGPpO7A7uPfzmGCMrvViItVZvkPAizSwnzPoY%2BVU4w%2BPIbqhvBVpFm%2FsDYWlhIF%2FWrX5Y6TZIJY3NRpqKHrqLSSr2V3mLmtP3uhaKMZSklmBxa8FyTOqEqBo%2FtrxsBW2jhmrM%2Bto8OA3GjsHdKeNuYCqZhzRRtD%2FgTW9rdfZwThKeNgvTGt%2FdQjtte%2BYS9wMTA4ba8ycZ9EFMWPTbpuSNVUP08hMjBJMV4eu5Y1DWtZn%2F42wcTHY8C7lT5sUpoF54t9Evj3vSj6ebuUzUAp3o9ESX3Vb8%2BFBeY1m9u7Fxoxl1EwhMYuxotSDdvCwivqgfJp57XH7Vwp2axQHa4qAgjN2AFPnoDJAGVsFojgaFcpGzuTA7vGN9rgpAnrgHsd7KqCn84rgyFil%2FPkbQFbpc%2B4nm9aT%2Bopcgod56wrXc62tyfmqbiV5LP6UZIw3O3kBNwtsL68en25XuKYvs8zKpsM1%2Fdm2WKVZ3YHxI61lSFTWmJFgBmwL0BoXMhHjJnuG6jHB8i6MLzQv70ZqavlYc2t4qojGPJEPbk7P6TA4ZmVOC%2BZh4vHN%2BB9JTFlyif4QTtyQuGp6bFtGb6x60XNCfX1V04EiYJcePTdVOv0Qq8KDCc13sCPorw4fI2ETt0KKqKEedjNQOuNawcZaY0djBnAQlBMXOyMO0cNvCCHf0U84nYpeFwhKB6GWFlkf0cLoWWKGksgEOt5jD7Tk1gJ3gb0svLauH4VVh1bwxokwpUV877pfu1I2fRbHp%2Birguy7KoJixXNtur9ATNiFmFc8ZChrqrAEFb%2FJ4xCnFhAiml2VWyy%2BIBrwHrDzBNWAGZ722poPpA9HrfG%2Fg64FsiS233Q7GPmIBAoot2%2Bikqq8T6JnSxSKfTCQW0DuhOyf%2B1M0rzR7gM%2Bqa6oCQs4uALHVmWTURtCwhODIM5O1o2ftDZgyd6N3J%2BpOK5OI%2BtHRpsQjSxIHj2vdpEX5O1Hy1TM0D4VVm86XLMtgde4PfAnWgkmjGHslIr9gOiJiPk4FXO7TPE6MGr5ea7qwGn8mS8t8Mp98NADYRm%2FAStEyHeQWwMbhg%2BQHk%2BDTCvcZA3ZpPfaSqwx8qegiTmOtbo4yTk6llAWWukXrMvNDVCBkiwLJEY0y%2BrubJqSWvWw1mCHNar%2FiSK%2F17j9rnpNwlN2os0AfSARAHlWVep6Au8SyUIuAVaPkXuLPlM%2B3iPZuoOXvApFtBtBn54tigcmGa1O0jXzgcAZJM9a1pHnEHdAn4R5758IDemZIkmPzpKJUkaldxufesHrq%2BXx1wJJSnBR6gSVU5ofd1xUORYNOLeC3DK0YQuS40duVOsLL%2B7IhrP4sS9APcQ%2FIFi%2FghZFxOd%2FB5TIsswRQmXzX3GBQnon7QadBo6XF6OpXDsaZjqhAH74ZimfaPmNjnb80jvyIv%2BhEFtH0Iv1f1sOUsA8K1Zv7ofk0CfoY8AYBQ%2Foof1%2BCzcp21x3G3SZK6iGSiFR8IYgI%2FC4lkPLilTLBXZCw75jx1JvlKcKB2u3SA%2BReS8YyXlEgWIyU8x7S1k9ZlBTCIvPA1UI%2Brfz1g0oWKiRbeE5%2BBHa8qeYU%3D&__ASYNCPOST=true&ctl00%24ContentPlaceHolder1%24btnSearchPlate=Search%20Plate' --compressed \
    | grep "Plate #: $1 not found"
}

if check_plate "$1" ; then
    echo -e "\x1b[32m\x1b[1mAll good!\x1b[0m"
else
    echo -e "\x1b[31m\x1b[1mSending alert email...\x1b[0m"
    sendmail.py -s "Check parking!" \
        -b "https://vats.municipalcitationsolutions.com/payments/PayVats.aspx\?location\=47" \
        -d $TARGET_EMAIL -a $SOURCE_EMAIL -p $SOURCE_EMAIL_PASSWORD
    echo -e "\x1b[1mEmail sent.\x1b[0m"
fi
